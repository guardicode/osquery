# Vulnerability Overview
### Platform: Windows
__[CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)__, also known as __PrintNightmare__, is a disclosed vulnerability in Microsoft Windows' PrintSpooler service.
The vulnerability was disclosed on June 28th 2021, and was patched by Microsoft in June's, July's and August's Patch Tuesday.
The vulnerability allows attackers to execute arbitrary files on a remote, vulnerable machine with SYSTEM privileges.

# Possible Mitigations
* Disable the print spooler
* prevent the spooler from receiving remote connections using GPO
* Install all and the latest OS patches

# Mitigation Queries
## Check if Spooler is running
```sql
SELECT status as "Spooler Service Status"
FROM services
WHERE name = "Spooler";
```
## Check if the Spooler is listening to incoming connections

```sql
SELECT 
    CASE WHEN EXISTS
        (
            SELECT 1
            FROM listening_ports AS l
            INNER JOIN processes AS p
            USING (pid)
            WHERE name = "spoolsv.exe" 
        )
    THEN "Listening For Remote Connections"
    ELSE "Not Listening For Remote Connections"
END AS "Is CVE-2021-34527 Vulnerable"; 
```

## Check if Microsoft's patches are installed

```sql
SELECT 
    CASE WHEN NOT EXISTS
        (
            SELECT 1
            FROM patches
            WHERE hotfix_id 
            IN (
                "KB5004948",
                "KB5004960",
                "KB5003696",
                "KB5004947",
                "KB5004955",
                "KB5004959",
                "KB5003697",
                "KB5004946",
                "KB5004950",
                "KB5003638",
                "KB5003667",
                "KB5004953",
                "KB5003681",
                "KB5003635",
                "KB5003646",
                "KB5004958",
                "KB5003695",
                "KB5003694",
                "KB5003671",
                "KB5003687",
                "KB5004951",
                "KB5004954",
                "KB5004945",
                "KB5003661",
                "KB5004956",
                "KB5003637"
            )
        )
    THEN 'PATCH_MISSING'
    ELSE 'SYSTEM_IS_PATCHED'
    END AS "Is CVE-2021-34527 Vulnerable";
```